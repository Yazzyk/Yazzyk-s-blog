<!DOCTYPE html>
<html lang="zh-cn">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yazzyk&#39;s Blog</title>
  <meta name="author" content="Yazzyk" />
  
  <meta name="description" content="使用背景 发现Caddy是我刚刚将博客换了个服务器，一时兴起，听闻IETF已经在今年(22年6月)推出了正式版HTTP3(RFC9114),那就干脆使得博客支持上，但找了半天，基于nginx都没有一个简" />
  
  <meta name="keywords" content="">
  <meta name="baidu-site-verification" content="code-TtzfDaB45q" />
  <meta name="google-site-verification" content="kAjz9Ic_7Hir1rNUQtXSxTydJTryAv8JMelb2Qvnges" />
  <link rel="shortcut icon" href="https://shroot.dev/img/favicon.png" type="image/x-icon">
  <link rel="stylesheet" href="https://shroot.dev/css/white.css">
  
  
  <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.2.1/css/all.min.css" rel="stylesheet">
  
  
  
  <script src="https://shroot.dev/js/jQuery.min.js" async="async"></script>
  <script src="https://shroot.dev/js/lodash.js" async="async"></script>
  <script src="https://shroot.dev/js/baidu.js" async="async"></script>
  
  <link rel="stylesheet" href="https://shroot.dev/css/main.css">
  
</head>
<body>
  <div class="nav">
  <div class="logoBox">
    <a href="/posts"><img src="/img/logo.png" alt="" class="logo"></a>
  </div>
  
  <ul>
    
    
    <li><a class="linkBox" href="/">欢迎页</a></li>
    
    <li><a class="linkBox" href="/posts">文章</a></li>
    
    <li><a class="linkBox" href="/about">关于我</a></li>
    
    <li><a class="linkBox" href="/tags">分类</a></li>
    
    <li><a class="linkBox" href="/links">友链</a></li>
    
  </ul>
</div>
<div class="header">
  <div class="subTitle">
    
    芝灵生于幽谷,不以无人而不芳
    
  </div>
  <div class="socials">
    <div class="socialLinks">
      
      <a href="mailto:917885215@qq.com" target="_blank"><i class="fa-solid fa-envelope" aria-hidden="true"></i></a>
      
      <a href="https://github.com/Yazzyk" target="_blank"><i class="fa-brands fa-github" aria-hidden="true"></i></a>
      
      <a href="#ZgotmplZ" target="_blank"><i class="fa-brands fa-qq" aria-hidden="true"></i></a>
      
      <a href="https://space.bilibili.com/10061915" target="_blank"><i class="fa-solid fa-tv" aria-hidden="true"></i></a>
      
    </div>
  </div>
</div>
  <div class="main">
    <div class="postContent">
      <h1>使用caddy2,docker-compose快速部署一个自带TLS和HTTP3的网站</h1>
      <small><i class="fa fa-clock-o" aria-hidden="true"></i>2022-12-11
        Yazzyk</small>
      <h2 id="使用背景">使用背景</h2>
<p>发现Caddy是我刚刚将博客换了个服务器，一时兴起，听闻IETF已经在今年(22年6月)推出了正式版<a href="https://datatracker.ietf.org/doc/html/rfc9114">HTTP3(RFC9114)</a>,那就干脆使得博客支持上，但找了半天，基于nginx都没有一个简单的方案，都是要去编译<code>nginx-quic</code>然后修改配置文件,看着就感觉好麻烦，也没有找到合适的docker来支持，弄完还得去弄证书来开启<code>https</code>。偶然间又看到一篇文章<a href="https://blog.csdn.net/wyyyh9458/article/details/121178999">利用Caddy轻松HTTPS，支持HTTP3/QUIC</a>,然后查了一下，发现<code>caddy</code>这个web服务器已经是<code>默认支持HTTP3</code>了，而且还可以自动去生成<code>TLS</code>证书，自动开启<code>https</code>，官方支持docker，那不快乐起来了吗！</p>
<h2 id="简介">简介</h2>
<p><a href="https://caddyserver.com/">Caddy</a>是一款用Golang编写的开源的web服务器，相比于Nginx来说有着以下优点</p>
<ol>
<li>可自动获取TLS证书</li>
<li>自动续签证书</li>
<li>默认支持HTTP3(RFC9114)协议</li>
<li>配置文件简单易上手</li>
</ol>
<h2 id="docker-composeyml">docker-compose.yml</h2>
<div class="highlight"><div style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#76a9f9">version</span><span style="color:#abb2bf">:</span> <span style="color:#63c381">&#34;3.7&#34;</span>

<span style="color:#76a9f9">services</span><span style="color:#abb2bf">:</span>
  <span style="color:#76a9f9">caddy</span><span style="color:#abb2bf">:</span>
    <span style="color:#76a9f9">container_name</span><span style="color:#abb2bf">:</span> <span style="color:#98c379">caddy-server</span>
    <span style="color:#76a9f9">image</span><span style="color:#abb2bf">:</span> <span style="color:#98c379">caddy:2.6.2</span>
    <span style="color:#76a9f9">restart</span><span style="color:#abb2bf">:</span> <span style="color:#98c379">always</span>
    <span style="color:#76a9f9">ports</span><span style="color:#abb2bf">:</span>
      - <span style="color:#63c381">&#34;80:80&#34;</span>
      - <span style="color:#63c381">&#34;443:443&#34;</span>
      - <span style="color:#63c381">&#34;443:443/udp&#34;</span>
    <span style="color:#76a9f9">volumes</span><span style="color:#abb2bf">:</span>
      - <span style="color:#98c379">$PWD/Caddyfile:/etc/caddy/Caddyfile</span>
      - <span style="color:#98c379">$PWD/site:/srv</span>
      - <span style="color:#98c379">$PWD/caddy_data:/data</span>
      - <span style="color:#98c379">$PWD/caddy_config:/config</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="创建一些映射出来的文件和文件夹">创建一些映射出来的文件和文件夹</h2>
<p>在<code>docker-compose.yml</code>同目录下</p>
<div class="highlight"><div style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">mkdir site
mkdir caddy_data
mkdir caddy_config
touch Caddyfile
</code></pre></td></tr></table>
</div>
</div><p>编辑<code>Caddyfile</code>(当然，也可以启动docker容器后copy出来)</p>
<div class="highlight"><div style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#58626f">35
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt"># The Caddyfile is an easy way to configure your Caddy web server.
#
# Unless the file starts with a global options block, the first
# uncommented line is always the address of your site.
#
# To use your own domain name (with automatic HTTPS), first make
# sure your domain&#39;s A/AAAA DNS records are properly pointed to
# this machine&#39;s public IP, then replace &#34;:80&#34; below with your
# domain name.

:80 {
        # Set this path to your site&#39;s directory.
        root * /usr/share/caddy

        # Enable the static file server.
        file_server

        # Another common task is to set up a reverse proxy:
        # reverse_proxy localhost:8080

        # Or serve a PHP site through php-fpm:
        # php_fastcgi localhost:9000
}

shroot.dev {
        root * /srv/shroot.dev
        encode gzip zstd
        file_server
}

www.shroot.dev {
        redir https://shroot.dev/{uri}
}
# Refer to the Caddy docs for more information:
# https://caddyserver.com/docs/caddyfile
</code></pre></td></tr></table>
</div>
</div><p>简单说下配置文件</p>
<ul>
<li><code>:80</code> 是caddy自带的一个页面,如下图<br>
<img src="./caddy-01.png" alt=""></li>
<li><code>shroot.dev</code> 是我的域名，当然，<code>:80</code>也是域名,从<a href="https://caddyserver.com/docs/caddyfile/concepts#addresses">文档</a>来看，<code>Caddy</code>对域名的格式要求并不严格</li>
<li><code>root * /srv/shroot.dev</code> 是网站根目录指向的<code>/srv/shroot.dev</code>这个路径，<code>*</code>是站点匹配路径,可以参考<a href="https://caddyserver.com/docs/caddyfile/directives/root#root">文档</a>,注意这个路径是docker容器内的，这个路径通过docker-compose被我们映射到了<code>site</code>目录下</li>
<li><code>file_server</code> 说明这是一个静态文件服务器，我们可以通过请求<code>URI</code>路径来访问站点，可以参考<a href="https://caddyserver.com/docs/caddyfile/directives/file_server#file-server">文档</a></li>
<li><code>encode</code> 是响应编码，典型用途是压缩，具体使用可参考<a href="https://caddyserver.com/docs/caddyfile/directives/encode#encode">文档</a></li>
<li>下面的<code>www.shroot.dev</code>下我使用了<code>redir</code>将<code>www.shroot.dev</code>这个域名重定向到了<code>shroot.dev</code></li>
</ul>
<p>以上我们就配置好了，接下来只需要将构建好的网站放入<code>site/shroot.dev</code>目录下,然后执行<code>docker-compose up -d</code>即可</p>
<p><code>https</code>和<code>http3</code>不需要任何的配置，caddy默认支持并开启，并且会自动跳转到https，我们只需要检查服务器的防火墙是否开启80和443端口，注意443端口是tcp和udp都打开，http3使用的是udp</p>
<h2 id="检查">检查</h2>
<p><code>docker ps</code>检查容器是否运行正常
<img src="caddy-02.png" alt=""></p>
<p>访问域名检查是否开启<code>https</code>和<code>http3</code>,如果Chrome没有Protocol，可以在Name那里鼠标右键勾上Protocol即可
<img src="caddy-03.png" alt=""><br>
<img src="caddy-04.png" alt=""></p>
<p>如果在<a href="https://http3check.net/">https://http3check.net/</a>和<a href="https://geekflare.com/tools/http3-test">https://geekflare.com/tools/http3-test</a>检查说网站不是Http3的话，其实可能是检查的网站协议不是最新的,而caddy已经不支持旧版的草案了，参考<a href="https://github.com/caddyserver/caddy/issues/5069">v2.6.0: HTTP/3 fails test on http3check.net #5069</a></p>

      <div class="postFooter">
        
        
        <small class="tags">
          <i class="fa fa-tag" aria-hidden="true"></i>caddy
        </small>
        
        <small class="tags">
          <i class="fa fa-tag" aria-hidden="true"></i>web
        </small>
        
        
      </div>
      <div>
        <ul class="post-copyright">
          <li class="post-copyright-link"><strong>本文链接：</strong> <a href="/posts/caddy/" title="使用caddy2,docker-compose快速部署一个自带TLS和HTTP3的网站 "
              class="line">使用caddy2,docker-compose快速部署一个自带TLS和HTTP3的网站</a></li>
          <li class="post-copyright-license"><strong>版权声明：</strong> 本<span xmlns:dct="http://purl.org/dc/terms/"
              href="http://purl.org/dc/dcmitype/Text" rel="dct:type">作品</span>由<span
              xmlns:cc="http://creativecommons.org/ns#" property="cc:attributionName">Yazzyk</span>采用<a
              rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/deed.zh">知识共享署名-非商业性使用 4.0
              国际许可协议</a>进行许可。<br />基于<a xmlns:dct="http://purl.org/dc/terms/" href="https://css0209.cn"
              rel="dct:source">Yazzyk&#39;s Blog</a>上的作品创作。转载请注明出处！</li>
        </ul>
      </div>
      
      
    </div>
  </div>
  <footer>
  <div class="leftBox">
    <span>Theme Designed by <a href="https://shroot.dev" target="_blank">Yazzyk</a></span><br />
    <span>Proudly published with <a href="https://gohugo.io" target="_blank">Hugo</a></span>
  </div>
  <div class="rightBox">
    <span>Copyright © 2020-2022.12 <a href="https://shroot.dev">Yazzyk</a> All Rights Reserved</span><br />
    
    
  </div>
</footer>
</body>

<script src="https://shroot.dev/js/list.js"></script>
<script src="https://shroot.dev/js/post.js"></script>